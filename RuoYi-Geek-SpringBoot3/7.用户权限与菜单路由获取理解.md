# 用户角色与权限获取

系统请求getInfo方法，该方法在任意一个页面跳转时都会调用，是在路由中配置的，前端用来获取用户信息。后端获取用户角色和权限信息，传递给前端

<img src= "./images/getInfo-request.png" alt="验证码请求">

```
请求url：http://localhost/dev-api/getInfo
```

permission.js  ：调用getInfo方法

```
// 判断当前用户是否已拉取完user_info信息
        useUserStore().getInfo().then(() => { //调用getInfo方法
          isRelogin.show = false
          usePermissionStore().generateRoutes().then(accessRoutes => {
            // 根据roles权限生成可访问的路由表
            accessRoutes.forEach(route => {
              if (!isHttp(route.path)) {
                router.addRoute(route) // 动态添加可访问路由表
              }
            })
            next({ ...to, replace: true }) // hack方法 确保addRoutes已完成
          })
        }).catch(err => {
          useUserStore().logOut().then(() => {
            ElMessage.error(err)
            next({ path: '/' })
          })
        })
```

user.ts:定义getInfo方法，对于后端的角色权限信息处理

```
getInfo() {
        return new Promise((resolve, reject) => {
          getInfo().then((res:any) => {
            const user = res.user
            // @ts-ignore
            const avatar = (user.avatar == "" || user.avatar == null) ? defAva : import.meta.env.VITE_APP_BASE_API + user.avatar;

            if (res.roles && res.roles.length > 0) { // 验证返回的roles是否是一个非空数组
              this.roles = res.roles
              this.permissions = res.permissions
            } else {
              this.roles = ['ROLE_DEFAULT']
            }
            this.name = user.userName
            this.avatar = avatar;
            resolve(res)
          }).catch(error => {
            reject(error)
          })
        })
      },
```

login.js

```
// 获取用户详细信息
export function getInfo() {
  return request({
    url: '/getInfo',
    method: 'get'
  })
}
```

后端：通过getInfo方法获取角色信息和权限信息，当权限为*：*： *时，表示所有权限，管理员拥有次此权限，其他用户没有，数据库中sys_user_role记录角色与权限的对应关系。

SysLoginController.java

> ```
>  @GetMapping("getInfo")
>     public AjaxResult getInfo() {
>         LoginUser loginUser = SecurityUtils.getLoginUser();
>         SysUser user = loginUser.getUser();
>         // 角色集合
>         Set<String> roles = permissionService.getRolePermission(user);
>         // 权限集合
>         Set<String> permissions = permissionService.getMenuPermission(user);
>     ······
>     }
> ```

# 动态菜单路由获取
